// 다음 좌표계 정보를 proj4 좌표계 변환 라이브러리에 전달
proj4.defs([["EPSG:5181","+proj=tmerc +lat_0=38 +lon_0=127 +k=1 +x_0=200000 +y_0=500000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"]]);
// 다음 좌표계용 좌표계 변환기 설정
var coordTranser = proj4("EPSG:5181");

// 다음 좌표에서 코스 이미지로 선형변환 하는 좌표계 MATRIX
var MATRIX = [
    [3.43948046e-02,  -1.58747091e+00,   6.55178766e+05],
    [-1.58747091e+00,  -3.43948046e-02,   3.00458907e+05],
    [0, 0, 1]
];
function M(i, j) {return MATRIX[i-1][j-1];}

// 자동차 이미지 크기의 절반을 위치 보정 값으로 설정
var IMAGE_X_OFFSET = 24;
var IMAGE_Y_OFFSET = 24;

// 각 버튼에 동작 부착
$( document ).ready(function() {
    $("#btn1").click(onBtn1);
    $("#btn2").click(onBtn2);
    $("#btn3").click(onBtn3);
});

function onBtn1() {
    var x = $("#x").val();
    try {
        x = parseFloat(x);
    } catch (e) {
        x = 0.0;
    }

    var y = $("#y").val();
    try {
        y = parseFloat(y);
    } catch (e) {
        y = 0.0;
    }

    moveToDaumCoord(x, y);
}

function onBtn2() {
    var lon = $("#lon").val();
    try {
        lon = parseFloat(lon);
    } catch (e) {
        lon = 0.0;
    }

    var lat = $("#lat").val();
    try {
        lat = parseFloat(lat);
    } catch (e) {
        lat = 0.0;
    }

    moveToLonLat(lon, lat);
}

// 자동으로 움직이게 인터벌 설정
var g_i = 0;
var g_interval = null;
function onBtn3() {
    g_i = 0;
    if (g_interval) {
        clearInterval(g_interval);
        g_interval = null;
    }
    g_interval = setInterval(autoMove, 1000);
}

// 자동차 아이콘을 원하는 위치로 이동
function moveCar(imgX, imgY) {
    $(".car").css({"position": "absolute", "top": (imgY-IMAGE_Y_OFFSET)+"px", "left": (imgX-IMAGE_X_OFFSET)+"px"});
}

// 다음 좌표계를 기준으로 아이콘 이동
function moveToDaumCoord(x, y) {
    var imgX = M(1,1)*x + M(1,2)*y + M(1,3);
    var imgY = M(2,1)*x + M(2,2)*y + M(2,3);

    moveCar(Math.round(imgX), Math.round(imgY));
}

// 경위도를 기준으로 아이콘 이동
function moveToLonLat(lon, lat) {
    var xy = coordTranser.forward([lon, lat]);
    var x = xy[0];
    var y = xy[1];

    var imgX = M(1,1)*x + M(1,2)*y + M(1,3);
    var imgY = M(2,1)*x + M(2,2)*y + M(2,3);

    moveCar(Math.round(imgX), Math.round(imgY));
}

// 자동이동
function autoMove() {
    if (g_i >= GPS.length) {
        clearInterval(g_interval);
        return;
    }

    data = GPS[g_i++];
    lon = data[0];
    lat = data[1];

    moveToLonLat(lon, lat);
}

// 다음지도에서 찍은 코스의 점 리스트
GPS = [ [ 126.77328249010948, 37.24747306062519 ], [ 126.772862541783311, 37.247418086408764 ], [ 126.772273863091613, 37.247140691682006 ], [ 126.771929987327852, 37.246576667792098 ], [ 126.771917855847775, 37.246105370347045 ], [ 126.772142682402745, 37.245699532389743 ], [ 126.772516362186053, 37.245364400301632 ], [ 126.772686684403908, 37.245055961539741 ], [ 126.772762242476432, 37.244714839032682 ], [ 126.772688311353875, 37.244514270169191 ], [ 126.772492548297464, 37.244270131683997 ], [ 126.772269993486987, 37.243923019379096 ], [ 126.772284245621364, 37.24369011811774 ], [ 126.772440932316584, 37.243408738127236 ], [ 126.772638466665896, 37.24306243299079 ], [ 126.772672930304651, 37.242867489077959 ], [ 126.77254512235082, 37.24255847768795 ], [ 126.772423895506591, 37.242314482159436 ], [ 126.772451665268179, 37.242092440685447 ], [ 126.772587940203266, 37.241838105933198 ], [ 126.772961956322845, 37.241383799979779 ], [ 126.773043651378288, 37.24125394982407 ], [ 126.773051287594697, 37.240966866196999 ], [ 126.772916494631531, 37.240728262057388 ], [ 126.772693460206639, 37.2405436578997 ], [ 126.772382151915465, 37.24042388706615 ], [ 126.772219804296711, 37.24033690372282 ], [ 126.77199678904212, 37.240146881332592 ], [ 126.771835095568449, 37.239843220747673 ], [ 126.771822606317869, 37.239491094964045 ], [ 126.772054302962118, 37.239047351280028 ], [ 126.772747669109677, 37.23828489384853 ], [ 126.773053217123916, 37.238063384802764 ], [ 126.77334480764975, 37.237977272027457 ], [ 126.773615829154949, 37.237972373482734 ], [ 126.773933904496559, 37.238092154029495 ], [ 126.774867521077965, 37.238548956475675 ], [ 126.775198716897791, 37.238815016231662 ], [ 126.775353646477782, 37.23911865946171 ], [ 126.775379718711392, 37.239465393732765 ], [ 126.775337523735388, 37.239985340875137 ], [ 126.77524319777244, 37.243229913801883 ], [ 126.77520172470382, 37.244646366448841 ], [ 126.775075551731504, 37.24606265788583 ], [ 126.774779141523993, 37.246620039697802 ], [ 126.774374699229426, 37.247047208282382 ], [ 126.77403173763075, 37.24730656756487 ], [ 126.773597646230797, 37.247449287372227 ], [ 126.773282066610591, 37.24747305981434 ] ]
